<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Enk</title>
  <script src="https://unpkg.com/vis-network@9.1.9/standalone/umd/vis-network.min.js"></script>
  <style>
/* 
 * Enk UI - Apple-inspired Design System
 * Clean, minimal, lots of whitespace, subtle depth
 */

:root {
  /* Light mode (default) */
  --bg-primary: #ffffff;
  --bg-secondary: #f5f5f7;
  --bg-tertiary: #e8e8ed;
  --bg-elevated: rgba(255, 255, 255, 0.72);
  --bg-glass: rgba(255, 255, 255, 0.65);
  
  --text-primary: #1d1d1f;
  --text-secondary: #6e6e73;
  --text-muted: #86868b;
  
  --accent: #007aff;
  --accent-hover: #0056b3;
  --accent-light: rgba(0, 122, 255, 0.1);
  
  --green: #34c759;
  --red: #ff3b30;
  --orange: #ff9500;
  --yellow: #ffcc00;
  --purple: #af52de;
  --pink: #ff2d55;
  --teal: #5ac8fa;
  
  --border: rgba(0, 0, 0, 0.06);
  --border-strong: rgba(0, 0, 0, 0.12);
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
  --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.12);
  
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
  
  --sidebar-width: 220px;
  
  --blur: blur(20px);
  --transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
}

/* Dark mode */
@media (prefers-color-scheme: dark) {
  :root {
    --bg-primary: #1c1c1e;
    --bg-secondary: #2c2c2e;
    --bg-tertiary: #3a3a3c;
    --bg-elevated: rgba(44, 44, 46, 0.72);
    --bg-glass: rgba(28, 28, 30, 0.65);
    
    --text-primary: #f5f5f7;
    --text-secondary: #a1a1a6;
    --text-muted: #8e8e93;
    
    --border: rgba(255, 255, 255, 0.08);
    --border-strong: rgba(255, 255, 255, 0.15);
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.2);
    --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
    --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.4);
  }
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  height: 100vh;
  display: flex;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-app-region: no-drag;
}

/* ─── Sidebar ─── */
.sidebar {
  width: var(--sidebar-width);
  background: var(--bg-secondary);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  border-right: 1px solid var(--border);
}

.sidebar-header {
  padding: 24px 20px 20px;
  -webkit-app-region: drag;
}

.sidebar-header h1 {
  font-size: 22px;
  font-weight: 600;
  letter-spacing: -0.5px;
  color: var(--text-primary);
}

.sidebar-header .subtitle {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 4px;
  font-weight: 400;
}

.nav {
  flex: 1;
  padding: 0 12px;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 12px;
  border-radius: var(--radius-md);
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  transition: var(--transition);
  user-select: none;
  margin-bottom: 2px;
}

.nav-item:hover { 
  background: var(--bg-tertiary); 
  color: var(--text-primary); 
}

.nav-item.active { 
  background: var(--accent-light); 
  color: var(--accent);
}

.nav-item svg { 
  width: 18px; 
  height: 18px; 
  flex-shrink: 0;
  opacity: 0.85;
}

.nav-item.active svg {
  opacity: 1;
}

.sidebar-stats {
  padding: 16px 20px;
  border-top: 1px solid var(--border);
  font-size: 12px;
  color: var(--text-muted);
}

.stat-row { 
  display: flex; 
  justify-content: space-between; 
  padding: 4px 0; 
}

.stat-val { 
  color: var(--text-secondary); 
  font-weight: 500;
  font-variant-numeric: tabular-nums;
}

.status-dot {
  display: inline-block;
  width: 8px; 
  height: 8px;
  border-radius: 50%;
  background: var(--green);
  margin-right: 6px;
  vertical-align: middle;
  box-shadow: 0 0 8px var(--green);
}

.status-dot.inactive { 
  background: var(--text-muted); 
  box-shadow: none;
}

/* ─── Main content ─── */
.main { 
  flex: 1; 
  display: flex; 
  flex-direction: column; 
  min-width: 0; 
  background: var(--bg-primary);
}

.view { 
  display: none; 
  flex: 1; 
  flex-direction: column; 
  min-height: 0; 
}

.view.active { display: flex; }

/* ─── Chat view ─── */
.messages {
  flex: 1;
  overflow-y: auto;
  padding: 32px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.messages::-webkit-scrollbar { width: 6px; }
.messages::-webkit-scrollbar-track { background: transparent; }
.messages::-webkit-scrollbar-thumb { 
  background: var(--bg-tertiary); 
  border-radius: 3px; 
}

.message {
  max-width: 70%;
  padding: 14px 18px;
  border-radius: var(--radius-xl);
  font-size: 15px;
  line-height: 1.5;
  word-wrap: break-word;
  white-space: pre-wrap;
}

.message.user {
  align-self: flex-end;
  background: var(--accent);
  color: white;
  border-bottom-right-radius: 6px;
}

.message.assistant {
  align-self: flex-start;
  background: var(--bg-secondary);
  color: var(--text-primary);
  border-bottom-left-radius: 6px;
}

.message.error {
  align-self: flex-start;
  background: rgba(255, 59, 48, 0.1);
  border: 1px solid rgba(255, 59, 48, 0.2);
  color: var(--red);
}

.message .msg-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 8px;
}

.message .timestamp {
  font-size: 11px;
  color: var(--text-muted);
}

.message.user .timestamp { 
  color: rgba(255, 255, 255, 0.7); 
}

.copy-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 4px 8px;
  font-size: 11px;
  border-radius: 6px;
  opacity: 0;
  transition: var(--transition);
}

.message:hover .copy-btn { opacity: 1; }
.copy-btn:hover { 
  background: var(--bg-tertiary); 
  color: var(--text-primary); 
}
.copy-btn.copied { 
  opacity: 1; 
  color: var(--green); 
}

.typing-indicator {
  align-self: flex-start;
  padding: 14px 18px;
  background: var(--bg-secondary);
  border-radius: var(--radius-xl);
  border-bottom-left-radius: 6px;
  display: none;
}

.typing-indicator.visible { 
  display: flex; 
  gap: 5px; 
  align-items: center; 
}

.typing-dot {
  width: 8px; 
  height: 8px;
  background: var(--text-muted);
  border-radius: 50%;
  animation: typingBounce 1.4s infinite;
}

.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typingBounce {
  0%, 60%, 100% { transform: translateY(0); }
  30% { transform: translateY(-8px); }
}

.welcome-msg {
  text-align: center;
  padding: 80px 48px;
  max-width: 480px;
  margin: 0 auto;
}

.welcome-msg h2 {
  font-size: 28px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 12px;
  letter-spacing: -0.5px;
}

.welcome-msg p { 
  font-size: 16px; 
  line-height: 1.6; 
  color: var(--text-secondary);
}

.suggestions {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  margin-top: 28px;
}

.suggestion {
  padding: 10px 18px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 100px;
  font-size: 14px;
  color: var(--text-secondary);
  cursor: pointer;
  transition: var(--transition);
  font-weight: 500;
}

.suggestion:hover { 
  background: var(--accent-light); 
  color: var(--accent); 
  border-color: var(--accent); 
}

.chat-input-area {
  padding: 20px 32px 28px;
  background: var(--bg-primary);
  border-top: 1px solid var(--border);
}

.input-wrapper {
  display: flex;
  gap: 12px;
  align-items: flex-end;
}

.chat-input {
  flex: 1;
  padding: 14px 18px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  color: var(--text-primary);
  font-size: 15px;
  font-family: inherit;
  resize: none;
  outline: none;
  max-height: 140px;
  line-height: 1.5;
  transition: var(--transition);
}

.chat-input:focus { 
  border-color: var(--accent); 
  box-shadow: 0 0 0 3px var(--accent-light);
}

.chat-input::placeholder { 
  color: var(--text-muted); 
}

.send-btn {
  width: 46px; 
  height: 46px;
  background: var(--accent);
  border: none;
  border-radius: var(--radius-md);
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
  flex-shrink: 0;
}

.send-btn:hover { 
  background: var(--accent-hover); 
  transform: scale(1.02);
}

.send-btn:disabled { 
  background: var(--bg-tertiary); 
  cursor: not-allowed;
  transform: none;
}

.send-btn svg { 
  width: 20px; 
  height: 20px; 
}

/* ─── Generic section styles ─── */
.activity-view,
.memory-view,
.settings-view { 
  padding: 32px; 
  overflow-y: auto; 
}

.activity-view h2,
.memory-view h2,
.settings-view h2 { 
  font-size: 24px; 
  font-weight: 600;
  margin-bottom: 24px;
  letter-spacing: -0.5px;
}

.activity-section { 
  margin-bottom: 36px; 
}

.activity-section h3 {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  margin-bottom: 16px;
  font-weight: 600;
}

/* ─── App bars ─── */
.app-bar-container { 
  display: flex; 
  flex-direction: column; 
  gap: 10px; 
}

.app-bar-row {
  display: flex;
  align-items: center;
  gap: 16px;
}

.app-bar-label {
  width: 140px;
  font-size: 14px;
  color: var(--text-secondary);
  text-align: right;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  flex-shrink: 0;
  font-weight: 500;
}

.app-bar-track {
  flex: 1;
  height: 28px;
  background: var(--bg-secondary);
  border-radius: var(--radius-sm);
  overflow: hidden;
}

.app-bar-fill {
  height: 100%;
  background: var(--accent);
  border-radius: var(--radius-sm);
  transition: width 0.5s ease;
  display: flex;
  align-items: center;
  padding-left: 12px;
  font-size: 12px;
  color: white;
  font-weight: 600;
  min-width: 48px;
}

/* ─── Timeline ─── */
.timeline-item {
  display: flex;
  gap: 16px;
  padding: 12px 0;
  font-size: 14px;
  border-bottom: 1px solid var(--border);
}

.timeline-time { 
  color: var(--text-muted); 
  flex-shrink: 0; 
  width: 56px;
  font-variant-numeric: tabular-nums;
}

.timeline-app { 
  color: var(--accent); 
  font-weight: 600; 
  flex-shrink: 0; 
  width: 120px; 
  overflow: hidden; 
  text-overflow: ellipsis; 
  white-space: nowrap; 
}

.timeline-title { 
  color: var(--text-secondary); 
  overflow: hidden; 
  text-overflow: ellipsis; 
  white-space: nowrap; 
}

/* ─── Action buttons ─── */
.action-btn {
  padding: 10px 20px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  color: var(--text-secondary);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
}

.action-btn:hover { 
  background: var(--accent-light); 
  color: var(--accent);
  border-color: var(--accent);
}

.action-btns { 
  display: flex; 
  gap: 10px; 
  flex-wrap: wrap; 
}

/* ─── Memory cards ─── */
.md-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: var(--transition);
}

.md-card:hover { 
  border-color: var(--accent);
  box-shadow: var(--shadow-md);
  transform: translateY(-1px);
}

.md-card h4 { 
  font-size: 16px; 
  font-weight: 600;
  margin-bottom: 6px;
}

.md-card p { 
  font-size: 14px; 
  color: var(--text-secondary); 
  line-height: 1.5; 
}

/* ─── Settings ─── */
.form-group { 
  margin-bottom: 24px; 
}

.form-group label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.form-group input[type="password"],
.form-group input[type="text"] {
  width: 100%;
  padding: 12px 16px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  color: var(--text-primary);
  font-size: 14px;
  font-family: 'SF Mono', 'Fira Code', monospace;
  outline: none;
  transition: var(--transition);
}

.form-group input:focus { 
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-light);
}

.toggle-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--bg-secondary);
  padding: 16px 20px;
  border-radius: var(--radius-md);
  border: 1px solid var(--border);
  margin-bottom: 10px;
}

.toggle-row span { 
  font-size: 15px; 
  color: var(--text-primary);
  font-weight: 500;
}

.toggle {
  position: relative;
  width: 51px; 
  height: 31px;
  cursor: pointer;
}

.toggle input { display: none; }

.toggle-slider {
  position: absolute;
  inset: 0;
  background: var(--bg-tertiary);
  border-radius: 16px;
  transition: var(--transition);
}

.toggle-slider::before {
  content: '';
  position: absolute;
  width: 27px; 
  height: 27px;
  background: white;
  border-radius: 50%;
  top: 2px; 
  left: 2px;
  transition: var(--transition);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.toggle input:checked + .toggle-slider { 
  background: var(--green); 
}

.toggle input:checked + .toggle-slider::before { 
  transform: translateX(20px); 
}

.settings-save {
  padding: 12px 28px;
  background: var(--accent);
  border: none;
  border-radius: var(--radius-md);
  color: white;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
}

.settings-save:hover { 
  background: var(--accent-hover);
  transform: scale(1.02);
}

.save-status {
  display: inline-block;
  margin-left: 16px;
  font-size: 14px;
  color: var(--green);
  opacity: 0;
  transition: var(--transition);
  font-weight: 500;
}

.save-status.visible { opacity: 1; }

/* ─── Search ─── */
.search-bar {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}

.search-input {
  flex: 1;
  padding: 12px 16px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  color: var(--text-primary);
  font-size: 14px;
  outline: none;
  transition: var(--transition);
}

.search-input:focus { 
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-light);
}

.search-btn {
  padding: 12px 20px;
  background: var(--accent);
  border: none;
  border-radius: var(--radius-md);
  color: white;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
}

.search-btn:hover {
  background: var(--accent-hover);
}

/* ─── Graph chips ─── */
.graph-chip {
  font-size: 12px; 
  padding: 5px 12px; 
  border-radius: 100px; 
  cursor: pointer;
  border: 1px solid var(--chip-color, var(--border));
  background: transparent; 
  color: var(--chip-color, var(--text-muted));
  transition: var(--transition); 
  font-family: inherit;
  font-weight: 500;
}

.graph-chip.active {
  background: var(--chip-color, var(--border));
  color: white; 
  font-weight: 600;
}

.graph-chip:hover { 
  opacity: 0.85; 
}

.graph-time-btn {
  font-size: 11px; 
  padding: 4px 10px; 
  border-radius: 6px; 
  cursor: pointer;
  border: 1px solid var(--border); 
  background: transparent; 
  color: var(--text-muted);
  transition: var(--transition); 
  font-family: inherit;
  font-weight: 500;
}

.graph-time-btn.active {
  background: var(--accent); 
  border-color: var(--accent); 
  color: #fff; 
  font-weight: 600;
}

.graph-time-btn:hover:not(.active) { 
  border-color: var(--text-muted); 
}

/* ─── Inspector ─── */
.inspector-section { 
  margin-bottom: 16px; 
}

.inspector-section-title {
  font-size: 11px; 
  text-transform: uppercase; 
  letter-spacing: 0.5px;
  color: var(--text-muted); 
  margin-bottom: 8px; 
  font-weight: 600;
}

.inspector-badge {
  display: inline-block; 
  font-size: 11px; 
  padding: 2px 8px; 
  border-radius: 6px;
  font-weight: 600; 
  vertical-align: middle; 
  margin-left: 6px;
}

.inspector-activity-item {
  font-size: 12px; 
  color: var(--text-secondary); 
  padding: 6px 0;
  border-bottom: 1px solid var(--border); 
  line-height: 1.5;
}

.inspector-activity-item:last-child { 
  border-bottom: none; 
}

.inspector-connection {
  display: inline-flex; 
  align-items: center; 
  gap: 6px; 
  font-size: 12px;
  padding: 4px 10px; 
  border-radius: var(--radius-sm); 
  background: var(--bg-secondary);
  border: 1px solid var(--border); 
  margin: 3px 3px 3px 0; 
  cursor: pointer;
  transition: var(--transition);
  font-weight: 500;
}

.inspector-connection:hover { 
  border-color: var(--accent); 
}

.inspector-connection .conn-dot {
  width: 8px; 
  height: 8px; 
  border-radius: 50%; 
  flex-shrink: 0;
}

/* ─── Glass effects ─── */
.glass {
  background: var(--bg-glass);
  backdrop-filter: var(--blur);
  -webkit-backdrop-filter: var(--blur);
}

/* ─── Entity filters ─── */
.entity-filter-panel {
  max-height: 200px;
  overflow-y: auto;
  margin-top: 10px;
  padding: 12px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  display: none;
}

.entity-filter-panel.visible { display: block; }

.entity-filter-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
}

.entity-filter-title {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
}

.entity-filter-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 8px;
  border-radius: 6px;
  cursor: pointer;
  transition: var(--transition);
  font-size: 13px;
  color: var(--text-secondary);
}

.entity-filter-item:hover { 
  background: var(--bg-tertiary); 
}

.entity-filter-item.selected { 
  background: var(--accent-light); 
  color: var(--text-primary);
}

/* ─── Scrollbars ─── */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { 
  background: var(--bg-tertiary); 
  border-radius: 4px;
}
::-webkit-scrollbar-thumb:hover {
  background: var(--text-muted);
}
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h1>Enk</h1>
      <div class="subtitle">Personal Memory Assistant</div>
    </div>
    <div class="nav">
      <div class="nav-item active" data-view="chat">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        Chat
      </div>
      <div class="nav-item" data-view="activity">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        Activity
      </div>
      <div class="nav-item" data-view="graph">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="3"/><circle cx="5" cy="19" r="3"/><circle cx="19" cy="19" r="3"/><line x1="12" y1="8" x2="5" y2="16"/><line x1="12" y1="8" x2="19" y2="16"/></svg>
        Context Graph
      </div>
      <div class="nav-item" data-view="memory">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        Memory Files
      </div>
      <div class="nav-item" data-view="settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        Settings
      </div>
    </div>
    <div class="sidebar-stats">
      <div class="stat-row">
        <span><span class="status-dot" id="sidebarDot"></span>Status</span>
        <span class="stat-val" id="sidebarStatus">Active</span>
      </div>
      <div class="stat-row">
        <span>Switches</span>
        <span class="stat-val" id="sidebarSwitches">0</span>
      </div>
      <div class="stat-row">
        <span>Top App</span>
        <span class="stat-val" id="sidebarTopApp">--</span>
      </div>
      <div class="stat-row">
        <span>Pending Flush</span>
        <span class="stat-val" id="sidebarPending">0</span>
      </div>
      <div class="stat-row">
        <span>OCR Captures</span>
        <span class="stat-val" id="sidebarSnapshots">0</span>
      </div>
      <div class="stat-row">
        <span>Entities</span>
        <span class="stat-val" id="sidebarEntities">0</span>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main">
    <!-- Chat View -->
    <div class="view active" id="chatView">
      <div class="messages" id="messages">
        <div class="welcome-msg" id="welcomeMsg">
          <h2>Hey there</h2>
          <p>I'm Enk, your personal memory assistant.<br>Ask me anything about your computer activity.</p>
          <div class="suggestions">
            <div class="suggestion" data-q="What did I do in the last hour?">Last hour summary</div>
            <div class="suggestion" data-q="Which apps did I use the most today?">Top apps today</div>
            <div class="suggestion" data-q="Show me any patterns you've noticed">My patterns</div>
            <div class="suggestion" data-q="What was I reading recently?">Recent reading</div>
          </div>
        </div>
      </div>
      <div class="typing-indicator" id="typingIndicator">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
      <div class="chat-input-area">
        <div class="input-wrapper">
          <textarea class="chat-input" id="chatInput" rows="1" placeholder="Ask about your activity..." autocomplete="off"></textarea>
          <button class="send-btn" id="sendBtn" title="Send">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Activity View -->
    <div class="view" id="activityView">
      <div class="activity-view">
        <h2>Activity Dashboard</h2>

        <div class="activity-section">
          <h3>App Usage (Current Session)</h3>
          <div class="app-bar-container" id="appBars"></div>
        </div>

        <div class="activity-section">
          <h3>Recent Timeline</h3>
          <div id="timeline"></div>
        </div>

        <div class="activity-section">
          <h3>Actions</h3>
          <div class="action-btns">
            <button class="action-btn" id="flushBtn">Flush to Nia Now</button>
            <button class="action-btn" id="detectPatternsBtn">Detect Patterns Now</button>
          </div>
        </div>

        <div class="activity-section">
          <h3>Search Nia Memories</h3>
          <div class="search-bar">
            <input class="search-input" id="niaSearchInput" placeholder="Search your memories...">
            <button class="search-btn" id="niaSearchBtn">Search</button>
          </div>
          <div id="niaSearchResults"></div>
        </div>
      </div>
    </div>

    <!-- Memory Files View -->
    <div class="view" id="memoryView">
      <div class="memory-view" id="memoryList">
        <h2>Memory Files</h2>
        <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 20px;">
          Your assistant's personality and memory, modeled after OpenClaw's soul.md / user.md system.
        </p>
        <div class="md-card" data-type="soul">
          <h4>soul.md</h4>
          <p>Enk's core identity, personality, and behavioral rules (procedural memory)</p>
        </div>
        <div class="md-card" data-type="user">
          <h4>user.md</h4>
          <p>Your profile, preferences, and context (fact memory)</p>
        </div>
        <div class="md-card" data-type="patterns">
          <h4>patterns.md</h4>
          <p>Detected recurring behaviors and suggestions (fact memory)</p>
        </div>
        <div class="md-card" data-type="daily">
          <h4>Daily Summary</h4>
          <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
            <input type="date" class="date-picker" id="dailyDatePicker">
            <span style="font-size: 12px; color: var(--text-muted);">Pick a date to view</span>
          </div>
        </div>

        <h2 style="margin-top: 32px;">Nia Brain</h2>
        <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 12px;">
          Everything Nia knows about you — all stored memories, grouped by type.
        </p>
        <div class="action-btns" style="margin-bottom: 16px;">
          <button class="action-btn" id="loadNiaBrainBtn">Load All Memories</button>
          <span id="niaBrainCount" style="font-size: 12px; color: var(--text-muted); align-self: center;"></span>
        </div>
        <div id="niaBrainContainer"></div>
      </div>
      <div class="md-viewer" id="mdViewer">
        <div class="memory-view">
          <div class="md-viewer-header">
            <button class="md-back-btn" id="mdBackBtn">&larr; Back</button>
            <h3 id="mdViewerTitle">soul.md</h3>
          </div>
          <div class="md-content" id="mdContent">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Context Graph View -->
    <div class="view" id="graphView">
      <div style="display:flex;height:100%;overflow:hidden;">
        <!-- Left: Graph Canvas -->
        <div style="flex:1;display:flex;flex-direction:column;min-width:0;">
          <div style="padding:12px 16px 6px;display:flex;align-items:center;gap:10px;flex-shrink:0;">
            <h2 style="font-size:17px;margin:0;font-weight:600;">Context Graph</h2>
            <span id="graphNodeCount" style="font-size:11px;color:var(--text-muted);"></span>
            <button class="action-btn" id="refreshGraphBtn" style="margin-left:auto;font-size:11px;padding:4px 10px;">Refresh</button>
          </div>
          <div id="graphCanvas" style="flex:1;position:relative;margin:0 8px 8px 16px;border-radius:12px;background:var(--bg-secondary);border:1px solid var(--border);overflow:hidden;">
            <div id="graphContainer" style="width:100%;height:100%;"></div>
            <!-- Zoom indicator -->
            <div id="graphZoomIndicator" style="position:absolute;bottom:10px;right:10px;padding:4px 8px;border-radius:6px;background:rgba(15,23,42,0.85);border:1px solid rgba(148,163,184,0.25);font-size:11px;color:var(--text-muted);pointer-events:none;z-index:50;">100%</div>
            <!-- Hover tooltip -->
            <div id="graphTooltip" style="display:none;position:absolute;pointer-events:none;z-index:100;padding:6px 10px;border-radius:8px;background:rgba(15,23,42,0.85);backdrop-filter:blur(12px);border:1px solid rgba(148,163,184,0.2);font-size:12px;color:#e2e8f0;white-space:nowrap;box-shadow:0 4px 12px rgba(0,0,0,0.3);max-width:280px;"></div>
          </div>
        </div>

        <!-- Right: Inspector Panel -->
        <div id="graphInspector" style="width:320px;flex-shrink:0;display:flex;flex-direction:column;border-left:1px solid var(--border);overflow:hidden;">
          <!-- Filters -->
          <div style="padding:12px 14px;border-bottom:1px solid var(--border);flex-shrink:0;">
            <input type="text" id="graphSearch" placeholder="Search entities..." style="width:100%;background:var(--bg-primary);border:1px solid var(--border);border-radius:8px;padding:6px 10px;color:var(--text-primary);font-size:12px;outline:none;margin-bottom:8px;">
            <div id="typeFilters" style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px;">
              <div class="graph-chip-wrapper" data-type="person">
                <button class="graph-chip active" data-type="person" style="--chip-color:#3b82f6;">Person <span class="graph-chip-expand">▼</span></button>
              </div>
              <div class="graph-chip-wrapper" data-type="topic">
                <button class="graph-chip active" data-type="topic" style="--chip-color:#4ade80;">Topic <span class="graph-chip-expand">▼</span></button>
              </div>
              <div class="graph-chip-wrapper" data-type="content">
                <button class="graph-chip active" data-type="content" style="--chip-color:#f97316;">Content <span class="graph-chip-expand">▼</span></button>
              </div>
              <div class="graph-chip-wrapper" data-type="project">
                <button class="graph-chip active" data-type="project" style="--chip-color:#a78bfa;">Project <span class="graph-chip-expand">▼</span></button>
              </div>
              <div class="graph-chip-wrapper" data-type="place">
                <button class="graph-chip active" data-type="place" style="--chip-color:#ef4444;">Place <span class="graph-chip-expand">▼</span></button>
              </div>
              <div class="graph-chip-wrapper" data-type="goal">
                <button class="graph-chip active" data-type="goal" style="--chip-color:#f59e0b;">Goal <span class="graph-chip-expand">▼</span></button>
              </div>
            </div>
            <!-- Entity sub-filter panel (shown when type chip is clicked) -->
            <div id="entityFilterPanel" class="entity-filter-panel">
              <div class="entity-filter-header">
                <span class="entity-filter-title" id="entityFilterTitle">Filter Entities</span>
                <div class="entity-filter-actions">
                  <button class="entity-filter-btn" id="entitySelectAll">All</button>
                  <button class="entity-filter-btn" id="entitySelectNone">None</button>
                </div>
              </div>
              <div class="entity-filter-list" id="entityFilterList"></div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
              <div id="timeFilter" style="display:flex;gap:3px;">
                <button class="graph-time-btn active" data-mins="0">All</button>
                <button class="graph-time-btn" data-mins="5">5m</button>
                <button class="graph-time-btn" data-mins="15">15m</button>
                <button class="graph-time-btn" data-mins="60">1h</button>
              </div>
              <label style="display:flex;align-items:center;gap:4px;font-size:10px;color:var(--text-muted);cursor:pointer;white-space:nowrap;">
                <input type="checkbox" id="verifiedOnly" style="width:12px;height:12px;accent-color:var(--green);"> Verified
              </label>
            </div>
          </div>

          <!-- Graph actions -->
          <div style="padding:10px 14px;border-bottom:1px solid var(--border);flex-shrink:0;">
            <div style="display:flex;gap:6px;margin-bottom:6px;flex-wrap:wrap;">
              <button id="exportGraphTextBtn" style="font-size:11px;padding:8px 12px;background:none;border:1px solid var(--border);border-radius:8px;color:var(--text-muted);cursor:pointer;" title="Copy text representation of the full graph">Export as text</button>
              <button id="pruneNoiseBtn" style="font-size:11px;padding:8px 12px;background:none;border:1px solid var(--border);border-radius:8px;color:var(--text-muted);cursor:pointer;" title="Use AI to remove noise nodes (generic words, UI artifacts) and merge duplicates">Prune noise</button>
              <button id="resetGraphBtn" style="font-size:11px;padding:8px 12px;background:none;border:1px solid var(--border);border-radius:8px;color:var(--red, #ef4444);cursor:pointer;" title="Clear all entities and connections. Starts fresh.">Reset graph</button>
            </div>
            <div id="graphActionStatus" style="font-size:10px;color:var(--text-muted);min-height:14px;white-space:pre-wrap;"></div>
          </div>

          <!-- What Enk Knows (understanding gauge) -->
          <div id="understandingCard" style="padding:10px 14px;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--bg-primary);">
            <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);margin-bottom:6px;">What Enk Knows</div>
            <div id="understandingContent" style="font-size:11px;color:var(--text-secondary);line-height:1.5;max-height:80px;overflow-y:auto;"></div>
            <div id="understandingStats" style="font-size:10px;color:var(--text-muted);margin-top:4px;"></div>
          </div>

          <!-- Selection info bar -->
          <div id="selectionBar" style="padding:10px 14px;border-bottom:1px solid var(--border);display:none;flex-shrink:0;background:rgba(59,130,246,0.12);border-left:3px solid var(--accent);">
            <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px;">
              <div style="flex:1;min-width:0;">
                <div id="selectionCount" style="font-size:12px;color:var(--accent);font-weight:600;margin-bottom:4px;"></div>
                <div id="selectionPreview" style="font-size:11px;color:var(--text-secondary);font-style:italic;line-height:1.4;"></div>
              </div>
              <div style="display:flex;gap:6px;flex-shrink:0;">
                <button id="analyzeGroupBtn" class="action-btn" style="font-size:11px;padding:4px 10px;">Analyze</button>
                <button id="clearSelectionBtn" style="font-size:11px;padding:4px 10px;background:none;border:1px solid var(--border);border-radius:6px;color:var(--text-muted);cursor:pointer;">Clear</button>
              </div>
            </div>
          </div>

          <!-- Detail pane (scrollable) -->
          <div id="inspectorContent" style="flex:1;overflow-y:auto;padding:12px 14px;">
            <div id="inspectorEmpty" style="color:var(--text-muted);font-size:13px;line-height:1.6;">
              <div style="margin-bottom:12px;font-weight:500;color:var(--text-secondary);">How to use</div>
              <div style="margin-bottom:6px;">Click a node or edge to inspect it.</div>
              <div style="margin-bottom:6px;">Shift+click to select multiple nodes, then hit Analyze to understand relationships.</div>
              <div>Use filters above to narrow by type, time, or search.</div>
            </div>
            <div id="inspectorDetail" style="display:none;"></div>
            <div id="inspectorAnalysis" style="display:none;"></div>
          </div>

          <!-- Knowledge preview at bottom -->
          <div style="border-top:1px solid var(--border);padding:10px 14px;flex-shrink:0;">
            <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);margin-bottom:6px;">Knowledge</div>
            <div id="knowledgePreview" style="font-size:11px;color:var(--text-secondary);white-space:pre-wrap;max-height:100px;overflow-y:auto;font-family:'SF Mono','Fira Code',monospace;line-height:1.5;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings View -->
    <div class="view" id="settingsView">
      <div class="settings-view">
        <h2>Settings</h2>

        <div id="setupBanner" style="display:none; background: rgba(59,130,246,0.12); border: 1px solid rgba(59,130,246,0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
          <div style="font-size: 15px; font-weight: 600; margin-bottom: 8px; color: var(--accent);">Setup Required</div>
          <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
            <strong>1. API Keys:</strong> Enter both keys below and click Save.<br>
            <strong>2. Screen Recording:</strong> Go to <em>System Settings &gt; Privacy &amp; Security &gt; Screen Recording</em>, click <strong>+</strong>, then navigate to:<br>
            <code style="background: var(--bg-primary); padding: 3px 6px; border-radius: 4px; font-size: 12px; display: inline-block; margin-top: 4px; word-break: break-all;">node_modules/electron/dist/Electron.app</code><br>
            <span style="font-size: 12px; color: var(--text-muted);">(inside your enk project folder)</span><br>
            After adding, restart the app.
          </div>
        </div>

        <div class="form-group">
          <label>Anthropic API Key (Claude)</label>
          <input type="password" id="settAnthropicKey" placeholder="sk-ant-api03-..." autocomplete="off" spellcheck="false">
        </div>
        <div class="form-group">
          <label>Nia API Key</label>
          <input type="password" id="settNiaKey" placeholder="nk_..." autocomplete="off" spellcheck="false">
        </div>
        <div class="form-group">
          <label>Vision API Key (OpenAI or Gemini)</label>
          <input type="password" id="settGeminiKey" placeholder="sk-... or AIza..." autocomplete="off" spellcheck="false">
          <p style="font-size: 11px; color: var(--text-muted); margin-top: 6px;">OpenAI (sk-...) uses GPT-4o-mini. Gemini (AIza...) uses Gemini 2.0 Flash.</p>
        </div>
        <div class="toggle-row">
          <span>Monitoring Active</span>
          <label class="toggle"><input type="checkbox" id="settEnabled" checked><span class="toggle-slider"></span></label>
        </div>
        <div class="toggle-row">
          <span>Scam Detection</span>
          <label class="toggle"><input type="checkbox" id="settScam" checked><span class="toggle-slider"></span></label>
        </div>
        <div class="toggle-row">
          <span>Vision Extraction</span>
          <label class="toggle"><input type="checkbox" id="settVision"><span class="toggle-slider"></span></label>
        </div>
        <div style="margin-top: 20px;">
          <button class="settings-save" id="settSaveBtn">Save Settings</button>
          <span class="save-status" id="settSaveStatus">Saved!</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ─── Navigation ───
    const navItems = document.querySelectorAll('.nav-item');
    const views = document.querySelectorAll('.view');

    navItems.forEach(item => {
      item.addEventListener('click', () => {
        const viewId = item.dataset.view + 'View';
        navItems.forEach(n => n.classList.remove('active'));
        views.forEach(v => v.classList.remove('active'));
        item.classList.add('active');
        document.getElementById(viewId).classList.add('active');

        if (item.dataset.view === 'activity') refreshActivity();
        if (item.dataset.view === 'graph') renderGraph();
      });
    });

    // ─── Chat ───
    const messagesEl = document.getElementById('messages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const typingIndicator = document.getElementById('typingIndicator');
    const welcomeMsg = document.getElementById('welcomeMsg');
    let chatHistory = [];

    function addMessage(role, text) {
      if (welcomeMsg.parentElement) welcomeMsg.style.display = 'none';

      const div = document.createElement('div');
      div.className = 'message ' + role;
      div.dataset.text = text;
      const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      div.innerHTML = `${escapeHtml(text)}<div class="msg-footer"><span class="timestamp">${time}</span><button class="copy-btn" onclick="copyMessage(this)">Copy</button></div>`;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      chatHistory.push({ role, text, time });
    }

    function copyMessage(btn) {
      const text = btn.closest('.message').dataset.text;
      navigator.clipboard.writeText(text).then(() => {
        btn.textContent = 'Copied!';
        btn.classList.add('copied');
        setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 1500);
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function sendMessage() {
      const query = chatInput.value.trim();
      if (!query) return;

      chatInput.value = '';
      chatInput.style.height = 'auto';
      sendBtn.disabled = true;
      addMessage('user', query);

      typingIndicator.classList.add('visible');
      messagesEl.scrollTop = messagesEl.scrollHeight;

      try {
        const result = await window.enk.chatQuery(query);
        typingIndicator.classList.remove('visible');

        if (result.error) {
          addMessage('error', result.error);
        } else {
          addMessage('assistant', result.response);
        }
      } catch (e) {
        typingIndicator.classList.remove('visible');
        addMessage('error', 'Something went wrong: ' + e.message);
      }

      sendBtn.disabled = false;
      chatInput.focus();
    }

    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Auto-resize textarea
    chatInput.addEventListener('input', () => {
      chatInput.style.height = 'auto';
      chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
    });

    // Suggestions
    document.querySelectorAll('.suggestion').forEach(s => {
      s.addEventListener('click', () => {
        chatInput.value = s.dataset.q;
        sendMessage();
      });
    });

    // ─── Activity ───
    const appBarsEl = document.getElementById('appBars');
    const timelineEl = document.getElementById('timeline');

    async function refreshActivity() {
      try {
        const stats = await window.enk.getActivityStats();

        // App bars
        const maxMins = stats.apps.length > 0 ? Math.max(stats.apps[0].seconds, 1) : 1;
        appBarsEl.innerHTML = stats.apps.slice(0, 10).map(a => {
          const pct = Math.max(5, (a.seconds / maxMins) * 100);
          const label = a.minutes > 0 ? `${a.minutes}m` : `${a.seconds}s`;
          return `<div class="app-bar-row">
            <div class="app-bar-label">${escapeHtml(a.app)}</div>
            <div class="app-bar-track"><div class="app-bar-fill" style="width:${pct}%">${label}</div></div>
          </div>`;
        }).join('') || '<div style="color:var(--text-muted);font-size:13px;">No activity data yet.</div>';

        // Timeline
        const allItems = stats.recentActivity.slice().reverse();
        const INITIAL_COUNT = 10;
        const renderTimeline = (items) => items.map(e => {
          const time = new Date(e.start).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
          const dur = Math.round(e.duration / 1000);
          const durStr = dur >= 60 ? `${Math.round(dur / 60)}m` : `${dur}s`;
          const display = e.summary || e.title;
          return `<div class="timeline-item">
            <div class="timeline-time">${time}</div>
            <div class="timeline-app">${escapeHtml(e.app)} <span style="color:var(--text-muted);font-weight:400">${durStr}</span></div>
            <div class="timeline-title">${escapeHtml(display)}</div>
          </div>`;
        }).join('');

        if (allItems.length === 0) {
          timelineEl.innerHTML = '<div style="color:var(--text-muted);font-size:13px;">No recent activity.</div>';
        } else if (allItems.length <= INITIAL_COUNT) {
          timelineEl.innerHTML = renderTimeline(allItems);
        } else {
          timelineEl.innerHTML = renderTimeline(allItems.slice(0, INITIAL_COUNT))
            + `<button class="action-btn" id="showMoreBtn" style="margin-top:12px;width:100%;text-align:center;">Show ${allItems.length - INITIAL_COUNT} more</button>`;
          document.getElementById('showMoreBtn').addEventListener('click', () => {
            timelineEl.innerHTML = renderTimeline(allItems)
              + `<button class="action-btn" id="showLessBtn" style="margin-top:12px;width:100%;text-align:center;">Show less</button>`;
            document.getElementById('showLessBtn').addEventListener('click', () => refreshActivity());
          });
        }

        // Sidebar stats
        document.getElementById('sidebarSwitches').textContent = stats.totalSwitches;
        if (stats.apps.length > 0) {
          document.getElementById('sidebarTopApp').textContent = stats.apps[0].app;
        }
      } catch (e) {
        console.error('Failed to refresh activity:', e);
      }
    }

    async function refreshSessionStats() {
      try {
        const ss = await window.enk.getSessionStats();
        document.getElementById('sidebarPending').textContent = ss.activityEntries;
        document.getElementById('sidebarSnapshots').textContent = ss.contentSnapshots;
        document.getElementById('sidebarEntities').textContent = ss.entityCount || 0;
      } catch {}
    }

    setInterval(refreshActivity, 10000);
    setInterval(refreshSessionStats, 5000);
    refreshActivity();
    refreshSessionStats();

    document.getElementById('flushBtn').addEventListener('click', async () => {
      const btn = document.getElementById('flushBtn');
      btn.textContent = 'Flushing...';
      await window.enk.flushNow();
      btn.textContent = 'Flushed!';
      setTimeout(() => { btn.textContent = 'Flush to Nia Now'; }, 2000);
    });

    document.getElementById('detectPatternsBtn').addEventListener('click', async () => {
      const btn = document.getElementById('detectPatternsBtn');
      btn.textContent = 'Analyzing...';
      await window.enk.detectPatternsNow();
      btn.textContent = 'Done!';
      setTimeout(() => { btn.textContent = 'Detect Patterns Now'; }, 2000);
    });

    // Nia search
    document.getElementById('niaSearchBtn').addEventListener('click', async () => {
      const query = document.getElementById('niaSearchInput').value.trim();
      if (!query) return;
      const results = await window.enk.searchNia(query);
      const container = document.getElementById('niaSearchResults');
      if (!results || results.length === 0) {
        container.innerHTML = '<div style="color:var(--text-muted);font-size:13px;padding:12px 0;">No results found.</div>';
        return;
      }
      container.innerHTML = results.map(r => `
        <div class="md-card" style="cursor:default;">
          <h4>${escapeHtml(r.title || 'Untitled')}</h4>
          <p>${escapeHtml((r.summary || r.content || '').slice(0, 200))}</p>
        </div>
      `).join('');
    });

    document.getElementById('niaSearchInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('niaSearchBtn').click();
    });

    // ─── Memory Files ───
    const memoryList = document.getElementById('memoryList');
    const mdViewer = document.getElementById('mdViewer');
    const mdContent = document.getElementById('mdContent');
    const mdViewerTitle = document.getElementById('mdViewerTitle');

    // Set default date to today
    document.getElementById('dailyDatePicker').valueAsDate = new Date();

    document.querySelectorAll('.md-card[data-type]').forEach(card => {
      card.addEventListener('click', async () => {
        const type = card.dataset.type;
        let date = null;
        if (type === 'daily') {
          date = document.getElementById('dailyDatePicker').value;
          if (!date) return;
        }

        mdViewerTitle.textContent = type === 'daily' ? `${date}.md` : `${type}.md`;
        mdContent.textContent = 'Loading...';
        memoryList.style.display = 'none';
        mdViewer.classList.add('active');

        const result = await window.enk.exportMd(type, date);
        if (result.error) {
          mdContent.textContent = 'Error: ' + result.error;
        } else {
          mdContent.textContent = result.content;
        }
      });
    });

    document.getElementById('mdBackBtn').addEventListener('click', () => {
      mdViewer.classList.remove('active');
      memoryList.style.display = 'block';
    });

    // ─── Nia Brain ───
    document.getElementById('loadNiaBrainBtn').addEventListener('click', async () => {
      const btn = document.getElementById('loadNiaBrainBtn');
      const container = document.getElementById('niaBrainContainer');
      btn.textContent = 'Loading...';
      container.innerHTML = '';

      try {
        const contexts = await window.enk.listNiaContexts({ limit: 100 });
        document.getElementById('niaBrainCount').textContent = `${contexts.length} memories found`;

        if (!contexts || contexts.length === 0) {
          container.innerHTML = '<div style="color:var(--text-muted);font-size:13px;">No memories stored yet.</div>';
          btn.textContent = 'Load All Memories';
          return;
        }

        const groups = {};
        for (const c of contexts) {
          const type = c.memory_type || 'unknown';
          if (!groups[type]) groups[type] = [];
          groups[type].push(c);
        }

        const typeLabels = {
          procedural: 'Procedural (permanent — identity/rules)',
          fact: 'Facts (permanent — interests, patterns, profile)',
          episodic: 'Episodic (7-day — activity logs)',
          scratchpad: 'Scratchpad (1-hour — working session)',
        };
        const typeOrder = ['fact', 'episodic', 'procedural', 'scratchpad'];

        let html = '';
        for (const type of typeOrder) {
          const items = groups[type];
          if (!items || items.length === 0) continue;
          const label = typeLabels[type] || type;
          html += `<div style="margin-bottom: 20px;">
            <h3 style="font-size:13px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);margin-bottom:8px;">${label} (${items.length})</h3>`;
          for (const item of items) {
            const title = escapeHtml(item.title || 'Untitled');
            const summary = escapeHtml((item.summary || '').slice(0, 150));
            const content = escapeHtml((item.content || '').slice(0, 500));
            const tags = (item.tags || []).map(t => `<span style="background:var(--bg-primary);padding:2px 6px;border-radius:4px;font-size:10px;color:var(--text-muted);">${escapeHtml(t)}</span>`).join(' ');
            html += `<div class="md-card" style="cursor:pointer;" onclick="this.querySelector('.nia-detail').style.display = this.querySelector('.nia-detail').style.display === 'none' ? 'block' : 'none'">
              <h4 style="font-size:14px;">${title}</h4>
              <p style="font-size:12px;margin-top:2px;">${summary}</p>
              <div style="margin-top:4px;">${tags}</div>
              <div class="nia-detail" style="display:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--border);font-size:12px;color:var(--text-secondary);white-space:pre-wrap;font-family:'SF Mono','Fira Code',monospace;max-height:200px;overflow-y:auto;">${content}</div>
            </div>`;
          }
          html += '</div>';
        }
        container.innerHTML = html;
      } catch (e) {
        container.innerHTML = `<div style="color:var(--red);font-size:13px;">Failed to load: ${e.message}</div>`;
      }
      btn.textContent = 'Refresh';
    });

    // ─── Settings ───
    const settAnthropicKey = document.getElementById('settAnthropicKey');
    const settNiaKey = document.getElementById('settNiaKey');
    const settGeminiKey = document.getElementById('settGeminiKey');
    const settEnabled = document.getElementById('settEnabled');
    const settScam = document.getElementById('settScam');
    const settVision = document.getElementById('settVision');
    const settSaveBtn = document.getElementById('settSaveBtn');
    const settSaveStatus = document.getElementById('settSaveStatus');

    function switchToView(viewName) {
      navItems.forEach(n => n.classList.remove('active'));
      views.forEach(v => v.classList.remove('active'));
      const navItem = document.querySelector(`.nav-item[data-view="${viewName}"]`);
      if (navItem) navItem.classList.add('active');
      document.getElementById(viewName + 'View').classList.add('active');
    }

    window.enk.getSettings().then(s => {
      if (s.anthropicKey) settAnthropicKey.value = s.anthropicKey;
      if (s.niaKey) settNiaKey.value = s.niaKey;
      if (s.geminiKey) settGeminiKey.value = s.geminiKey;
      settEnabled.checked = s.enabled;
      settScam.checked = s.scamDetection;
      settVision.checked = s.useVisionExtraction || false;

      if (!s.anthropicKey || !s.niaKey) {
        switchToView('settings');
        document.getElementById('setupBanner').style.display = 'block';
      }
    });

    settSaveBtn.addEventListener('click', async () => {
      await window.enk.saveSettings({
        anthropicKey: settAnthropicKey.value.trim(),
        niaKey: settNiaKey.value.trim(),
        geminiKey: settGeminiKey.value.trim(),
        enabled: settEnabled.checked,
        scamDetection: settScam.checked,
        useVisionExtraction: settVision.checked,
        firstLaunch: false,
      });
      settSaveStatus.classList.add('visible');
      setTimeout(() => settSaveStatus.classList.remove('visible'), 2000);
    });

    // ─── Status updates ───
    const sidebarDot = document.getElementById('sidebarDot');
    const sidebarStatus = document.getElementById('sidebarStatus');

    window.enk.onStatusUpdate((status) => {
      sidebarDot.className = 'status-dot' + (status === 'inactive' ? ' inactive' : '');
      const labels = { active: 'Active', processing: 'Processing', threat: 'Threat!', inactive: 'Inactive' };
      sidebarStatus.textContent = labels[status] || status;
    });

    // ─── Context Graph ──────────────────────────────────────────
    let graphNetwork = null;
    let graphNodesDS = null;
    let graphEdgesDS = null;
    let graphRawData = null;
    let selectedNodes = new Set();
    const activeTypeFilters = new Set(['person','topic','content','project','place','goal']);
    let activeTimeFilter = 0;
    let searchQuery = '';
    let verifiedOnly = false;

    const TYPE_COLORS = {
      app: '#64748b', person: '#3b82f6', topic: '#4ade80',
      content: '#f97316', place: '#ef4444', project: '#a78bfa', goal: '#f59e0b',
    };

    function fmtTime(ts) {
      return ts ? new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '?';
    }
    function fmtDuration(ms) {
      const s = Math.round(ms / 1000);
      return s >= 60 ? `${Math.floor(s/60)}m ${s%60}s` : `${s}s`;
    }

    function shouldShowNode(n) {
      // Type filter
      if (!activeTypeFilters.has(n._type)) return false;
      
      // Entity-level filter (if specific entities selected for this type)
      const entitySet = activeEntityFilters.get(n._type);
      if (entitySet && entitySet.size > 0 && !entitySet.has(n.id)) return false;
      if (entitySet && entitySet.size === 0) return false; // Empty set = show none
      
      // Time filter
      if (activeTimeFilter > 0) {
        const cutoff = Date.now() - activeTimeFilter * 60 * 1000;
        if (n._lastSeen < cutoff) return false;
      }
      
      // Search filter
      if (searchQuery && !n.label.toLowerCase().includes(searchQuery)) return false;
      
      // Verified filter
      if (verifiedOnly && !n._verified) return false;
      
      return true;
    }

    function applyFilters() {
      if (!graphNodesDS || !graphEdgesDS || !graphRawData) return;
      const now = Date.now();
      graphNodesDS.forEach(n => {
        const show = shouldShowNode(n);
        graphNodesDS.update({ id: n.id, hidden: !show });
      });
      graphEdgesDS.forEach(e => {
        const fromNode = graphNodesDS.get(e.from);
        const toNode = graphNodesDS.get(e.to);
        const show = fromNode && !fromNode.hidden && toNode && !toNode.hidden;
        graphEdgesDS.update({ id: e.id, hidden: !show });
      });
    }

    let previewDebounce = null;
    function updateSelectionUI() {
      const bar = document.getElementById('selectionBar');
      const countEl = document.getElementById('selectionCount');
      const previewEl = document.getElementById('selectionPreview');
      if (selectedNodes.size === 0) {
        bar.style.display = 'none';
        return;
      }
      bar.style.display = 'block';
      const labels = Array.from(selectedNodes).map(id => {
        const n = graphNodesDS?.get(id);
        return n ? n.label : id;
      });
      countEl.innerHTML = `<strong>${selectedNodes.size} selected</strong> — ${labels.map(l => `<span class="selected-node-tag">${l}</span>`).join('')}`;
      if (previewEl) previewEl.textContent = '...';

      // Highlight selected nodes — strong ring and glow
      if (graphNodesDS) {
        graphNodesDS.forEach(n => {
          const isSelected = selectedNodes.has(n.id);
          graphNodesDS.update({
            id: n.id,
            borderWidth: isSelected ? 5 : 2,
            shadow: isSelected ? { enabled: true, size: 18, color: 'rgba(59,130,246,0.6)' } : { enabled: false },
          });
        });
      }

      // Debounced group preview
      if (previewDebounce) clearTimeout(previewDebounce);
      if (selectedNodes.size >= 2) {
        previewDebounce = setTimeout(async () => {
          try {
            const r = await window.enk.previewGraphGroup(Array.from(selectedNodes));
            if (previewEl && r.preview) previewEl.textContent = '"' + r.preview + '"';
          } catch {}
        }, 350);
      } else if (previewEl) previewEl.textContent = '';
    }

    async function refreshUnderstanding() {
      const content = document.getElementById('understandingContent');
      const stats = document.getElementById('understandingStats');
      if (!content) return;
      try {
        const u = await window.enk.getUnderstandingPreview();
        content.textContent = u.knowledge || '(Nothing yet — keep using your computer)';
        if (stats) stats.textContent = `Based on ${u.activityCount || 0} activity entries, ${u.snapshotCount || 0} screen captures, ${u.entityCount || 0} entities`;
      } catch {}
    }

    async function showNodeDetail(nodeId) {
      const detail = document.getElementById('inspectorDetail');
      const empty = document.getElementById('inspectorEmpty');
      const analysis = document.getElementById('inspectorAnalysis');
      empty.style.display = 'none';
      analysis.style.display = 'none';
      detail.style.display = 'block';
      detail.innerHTML = '<div style="color:var(--text-muted);font-size:12px;">Loading...</div>';

      const d = await window.enk.getNodeDetail(nodeId);
      if (!d) { detail.innerHTML = '<div style="color:var(--text-muted);">Node not found</div>'; return; }

      const color = TYPE_COLORS[d.type] || '#64748b';
      let html = `<div class="inspector-section">
        <div style="font-size:16px;font-weight:600;margin-bottom:4px;">${d.label}</div>
        <span class="inspector-badge" style="background:${color};color:#0f172a;">${d.type}</span>
        ${d.verified ? '<span style="color:#4ade80;font-size:10px;margin-left:4px;font-weight:500;">&#10003; Verified</span>' : '<span style="color:var(--text-muted);font-size:10px;margin-left:4px;">Unverified</span>'}
        <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">
          ${d.mentions} mentions &middot; ${(d.contexts || []).length} context${(d.contexts || []).length !== 1 ? 's' : ''} &middot; since ${fmtTime(d.firstSeen)}
        </div>
        ${(d.contexts || []).length > 0 ? '<div style="font-size:10px;color:var(--text-muted);margin-top:2px;">Seen in: ' + d.contexts.join(', ') + '</div>' : ''}
      </div>`;

      if (d.connections && d.connections.length > 0) {
        html += `<div class="inspector-section">
          <div class="inspector-section-title">Connected To</div>
          <div style="display:flex;flex-wrap:wrap;">
            ${d.connections.map(c => `<span class="inspector-connection" data-node-id="${c.id}"><span class="conn-dot" style="background:${TYPE_COLORS[c.type]||'#64748b'}"></span>${c.label} <span style="color:var(--text-muted)">${c.coOccurrences}x</span>${c.relation ? `<span style="color:var(--accent);font-size:10px;margin-left:4px">(${c.relation.replace(/_/g, ' ')})</span>` : ''}</span>`).join('')}
          </div>
        </div>`;
      }

      if (d.context.relatedActivity.length > 0) {
        html += `<div class="inspector-section">
          <div class="inspector-section-title">Activity Timeline</div>
          ${d.context.relatedActivity.map(a => `<div class="inspector-activity-item">
            <strong>${a.app}</strong> &middot; ${fmtTime(a.start)} &middot; ${fmtDuration(a.duration)}<br>
            <span style="color:var(--text-muted);">${a.title}${a.url ? ' — <span style="color:var(--accent);font-size:10px;">' + a.url.slice(0,60) + '</span>' : ''}</span>
            ${a.summary ? '<br><span style="color:var(--text-secondary);font-style:italic;">' + a.summary + '</span>' : ''}
          </div>`).join('')}
        </div>`;
      }

      if (d.context.relatedContent.length > 0) {
        html += `<div class="inspector-section">
          <div class="inspector-section-title">Screen Context</div>
          ${d.context.relatedContent.map(c => `<div class="inspector-activity-item">
            <strong>${c.app}</strong> &middot; ${fmtTime(c.timestamp)}<br>
            ${c.summary ? '<span style="color:var(--text-secondary);">' + c.summary + '</span>' : '<span style="color:var(--text-muted);font-family:monospace;font-size:10px;">' + c.textPreview + '</span>'}
          </div>`).join('')}
        </div>`;
      }

      if (d.context.relatedClipboard.length > 0) {
        html += `<div class="inspector-section">
          <div class="inspector-section-title">Clipboard</div>
          ${d.context.relatedClipboard.map(c => `<div class="inspector-activity-item">
            <span style="color:var(--text-muted);">${fmtTime(c.timestamp)} in ${c.app}</span><br>
            <span style="font-family:monospace;font-size:10px;">${c.text}</span>
          </div>`).join('')}
        </div>`;
      }

      if (d.context.relatedMusic.length > 0) {
        html += `<div class="inspector-section">
          <div class="inspector-section-title">Music / Podcasts</div>
          ${d.context.relatedMusic.map(m => `<div class="inspector-activity-item">"${m.track}" by ${m.artist} <span style="color:var(--text-muted);">(${m.app})</span></div>`).join('')}
        </div>`;
      }

      detail.innerHTML = html;

      // Connection click -> navigate to that node
      detail.querySelectorAll('.inspector-connection').forEach(el => {
        el.addEventListener('click', () => {
          const targetId = el.dataset.nodeId;
          if (graphNetwork && graphNodesDS?.get(targetId)) {
            graphNetwork.focus(targetId, { scale: 1.2, animation: { duration: 400 } });
            graphNetwork.selectNodes([targetId]);
            showNodeDetail(targetId);
          }
        });
      });
    }

    async function showEdgeDetail(fromId, toId) {
      const detail = document.getElementById('inspectorDetail');
      const empty = document.getElementById('inspectorEmpty');
      const analysis = document.getElementById('inspectorAnalysis');
      empty.style.display = 'none';
      analysis.style.display = 'none';
      detail.style.display = 'block';
      detail.innerHTML = '<div style="color:var(--text-muted);font-size:12px;">Loading...</div>';

      const d = await window.enk.getEdgeDetail(fromId, toId);
      if (!d) { detail.innerHTML = '<div style="color:var(--text-muted);">Edge not found</div>'; return; }

      const srcColor = TYPE_COLORS[d.source.type] || '#64748b';
      const tgtColor = TYPE_COLORS[d.target.type] || '#64748b';

      const relationStr = d.relation ? ` &middot; <span style="color:var(--accent);">${d.relation.replace(/_/g, ' ')}</span>` : '';
      let html = `<div class="inspector-section">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
          <span class="inspector-badge" style="background:${srcColor};color:#0f172a;">${d.source.label}</span>
          <span style="color:var(--text-muted);">&#8596;</span>
          <span class="inspector-badge" style="background:${tgtColor};color:#0f172a;">${d.target.label}</span>
        </div>
        <div style="font-size:12px;color:var(--text-secondary);">
          Connected <strong>${d.weight}x</strong>${relationStr} — shared activity context or Nia memories
        </div>
      </div>`;

      if (d.sharedActivity.length > 0) {
        html += `<div class="inspector-section">
          <div class="inspector-section-title">Shared Activity Context</div>
          ${d.sharedActivity.map(a => `<div class="inspector-activity-item">
            <strong>${a.app}</strong> &middot; ${fmtTime(a.start)} &middot; ${fmtDuration(a.duration)}<br>
            <span style="color:var(--text-muted);">${a.title}</span>
            ${a.summary ? '<br><span style="color:var(--text-secondary);font-style:italic;">' + a.summary + '</span>' : ''}
          </div>`).join('')}
        </div>`;
      }

      detail.innerHTML = html;
    }

    async function analyzeGroup() {
      if (selectedNodes.size < 2) return;
      const analysis = document.getElementById('inspectorAnalysis');
      const detail = document.getElementById('inspectorDetail');
      const empty = document.getElementById('inspectorEmpty');
      empty.style.display = 'none';
      detail.style.display = 'none';
      analysis.style.display = 'block';
      analysis.innerHTML = '<div style="color:var(--text-muted);font-size:12px;">Analyzing group with AI...</div>';

      const result = await window.enk.analyzeGraphGroup(Array.from(selectedNodes));
      if (result.error) {
        analysis.innerHTML = `<div style="color:var(--red);font-size:12px;">${result.error}</div>`;
        return;
      }
      analysis.innerHTML = `<div class="inspector-section">
        <div class="inspector-section-title">AI Analysis</div>
        <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;white-space:pre-wrap;">${result.analysis}</div>
      </div>`;
    }

    async function renderGraph() {
      const container = document.getElementById('graphContainer');
      const countEl = document.getElementById('graphNodeCount');
      const knowledgeEl = document.getElementById('knowledgePreview');
      const tooltip = document.getElementById('graphTooltip');

      try {
        const data = await window.enk.getEntityGraph();
        const knowledge = await window.enk.getLocalKnowledge();
        graphRawData = data;

        if (knowledgeEl) {
          knowledgeEl.textContent = knowledge || '(Nothing yet -- keep using your computer)';
        }
        refreshUnderstanding();

        if (!data || !data.nodes || data.nodes.length === 0) {
          container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-muted);font-size:14px;">No entities captured yet. Keep using your computer...</div>';
          if (countEl) countEl.textContent = '';
          refreshUnderstanding();
          return;
        }

        if (countEl) countEl.textContent = `${data.nodes.length} entities, ${data.edges.length} connections`;

        graphNodesDS = new vis.DataSet(data.nodes.map(n => {
          const baseColor = TYPE_COLORS[n.type] || '#64748b';
          const weight = n.mentions || n.weight || 1;
          const diversity = n.contextDiversity || 1;
          const recency = n.lastSeen ? Math.max(0, 1 - (Date.now() - n.lastSeen) / (7 * 24 * 60 * 60 * 1000)) : 0.5;
          
          // Calculate importance score for visual sizing
          const importance = Math.log2(weight + 1) * (1 + diversity * 0.2) * (0.5 + recency * 0.5);
          const nodeSize = Math.min(Math.max(importance * 8, 12), 40);
          const fontSize = Math.min(Math.max(10 + importance * 1.5, 10), 16);
          
          const isVerified = n.verified || false;
          const bg = isVerified ? baseColor : baseColor + '99';
          const fontColor = isVerified ? '#f1f5f9' : '#94a3b8';
          
          return {
            id: n.id,
            label: n.label,
            value: nodeSize,
            color: {
              background: bg,
              border: baseColor,
              highlight: { background: '#fff', border: baseColor },
              hover: { background: baseColor, border: '#fff' },
            },
            font: { 
              color: fontColor, 
              size: fontSize,
              strokeWidth: isVerified ? 0 : 0,
            },
            _type: n.type,
            _mentions: weight,
            _importance: importance,
            _firstSeen: n.firstSeen,
            _lastSeen: n.lastSeen,
            _sourceLabel: n.label,
            _verified: isVerified,
            _contextDiversity: diversity,
            borderWidth: isVerified ? 3 : 1,
            borderDashes: isVerified ? false : [3, 3],
            shadow: isVerified ? { enabled: true, size: 8, color: baseColor + '40' } : false,
            hidden: false,
          };
        }));

        graphEdgesDS = new vis.DataSet(data.edges.map((e, i) => ({
          id: `e${i}`,
          from: e.source,
          to: e.target,
          value: e.weight,
          _weight: e.weight,
          _sourceLabel: e.sourceLabel,
          _targetLabel: e.targetLabel,
          _relation: e.relation || null,
          label: '',
          color: { color: 'rgba(148, 163, 184, 0.25)', highlight: 'rgba(59, 130, 246, 0.6)', hover: 'rgba(148, 163, 184, 0.5)' },
          smooth: { type: 'continuous' },
          hoverWidth: 2,
          hidden: false,
        })));

        if (window._graphZoomInterval) { clearInterval(window._graphZoomInterval); window._graphZoomInterval = null; }
        if (graphNetwork) graphNetwork.destroy();

        graphNetwork = new vis.Network(container, { nodes: graphNodesDS, edges: graphEdgesDS }, {
          physics: {
            enabled: true,
            solver: 'forceAtlas2Based',
            forceAtlas2Based: {
              gravitationalConstant: -80,
              centralGravity: 0.01,
              springLength: 100,
              springConstant: 0.08,
              damping: 0.4,
              avoidOverlap: 0.5,
            },
            stabilization: { enabled: true, iterations: 200, updateInterval: 25 },
            minVelocity: 0.75,
            maxVelocity: 30,
          },
          interaction: {
            hover: true,
            tooltipDelay: 0,
            multiselect: true,
            selectConnectedEdges: false,
            zoomSpeed: 0.4,
            zoomView: true,
            dragView: true,
            dragNodes: true,
            navigationButtons: false,
            keyboard: { enabled: true, bindToWindow: false },
          },
          nodes: {
            shape: 'dot',
            scaling: { 
              min: 12, 
              max: 45, 
              label: { enabled: true, min: 10, max: 16, drawThreshold: 8 } 
            },
            borderWidth: 2,
            shadow: false,
            font: { face: '-apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif' },
          },
          edges: {
            scaling: { min: 1, max: 5 },
            selectionWidth: 2,
            smooth: {
              enabled: true,
              type: 'continuous',
              roundness: 0.5,
            },
          },
          layout: {
            improvedLayout: true,
            clusterThreshold: 150,
          },
        });

        function updateZoomIndicator() {
          const el = document.getElementById('graphZoomIndicator');
          if (!el || !graphNetwork) return;
          try {
            const scale = graphNetwork.getScale();
            el.textContent = Math.round(scale * 100) + '%';
          } catch {}
        }
        graphNetwork.once('stabilizationIterationsDone', () => {
          graphNetwork.setOptions({ physics: false });
          graphNetwork.fit({ animation: { duration: 400 } });
          updateZoomIndicator();
        });
        setTimeout(() => {
          if (graphNetwork) {
            graphNetwork.setOptions({ physics: false });
            graphNetwork.fit({ animation: { duration: 400 } });
            updateZoomIndicator();
          }
        }, 2500);
        graphNetwork.on('zoom', updateZoomIndicator);
        graphNetwork.on('animationFinished', updateZoomIndicator);
        window._graphZoomInterval = setInterval(updateZoomIndicator, 400);

        applyFilters();

        // ── Hover tooltips ──
        let tooltipVisible = false;
        const canvasEl = document.getElementById('graphCanvas');

        canvasEl.addEventListener('mousemove', (evt) => {
          if (tooltipVisible) {
            const rect = canvasEl.getBoundingClientRect();
            const x = evt.clientX - rect.left + 14;
            const y = evt.clientY - rect.top + 14;
            const maxX = rect.width - tooltip.offsetWidth - 8;
            const maxY = rect.height - tooltip.offsetHeight - 8;
            tooltip.style.left = Math.min(x, maxX) + 'px';
            tooltip.style.top = Math.min(y, maxY) + 'px';
          }
        });

        graphNetwork.on('hoverNode', (params) => {
          const n = graphNodesDS.get(params.node);
          if (!n) return;
          const color = TYPE_COLORS[n._type] || '#64748b';
          const verifiedBadge = n._verified ? '<span style="color:#4ade80;font-size:9px;margin-left:3px;">&#10003;</span>' : '';
          const diversityStr = n._contextDiversity > 1 ? ` &middot; ${n._contextDiversity} contexts` : '';
          tooltip.innerHTML = `<span style="font-weight:600;">${n.label}</span> <span style="color:${color};font-size:10px;">${n._type}</span>${verifiedBadge}<br><span style="color:var(--text-muted);font-size:11px;">${n._mentions} mentions${diversityStr} &middot; ${fmtTime(n._lastSeen)}</span>`;
          tooltip.style.display = 'block';
          tooltipVisible = true;
        });

        graphNetwork.on('blurNode', () => {
          tooltip.style.display = 'none';
          tooltipVisible = false;
        });

        graphNetwork.on('hoverEdge', (params) => {
          const e = graphEdgesDS.get(params.edge);
          if (!e) return;
          const relStr = e._relation ? `<br><span style="color:var(--accent);font-size:11px;">${e._relation.replace(/_/g, ' ')}</span>` : '';
          tooltip.innerHTML = `<span style="font-weight:600;">${e._sourceLabel || '?'}</span> <span style="color:var(--text-muted);">&#8596;</span> <span style="font-weight:600;">${e._targetLabel || '?'}</span>${relStr}<br><span style="color:var(--text-muted);font-size:11px;">connected ${e._weight}x</span>`;
          tooltip.style.display = 'block';
          tooltipVisible = true;
        });

        graphNetwork.on('blurEdge', () => {
          tooltip.style.display = 'none';
          tooltipVisible = false;
        });

        // ── Click: node detail or edge detail ──
        graphNetwork.on('dragEnd', () => {
          if (graphNetwork && graphNetwork.physics) {
            try { graphNetwork.physics.physicsBody.simulation.restartSimulation?.(); } catch {}
          }
        });

        graphNetwork.on('click', (params) => {
          const isShift = params.event?.srcEvent?.shiftKey || false;

          if (params.nodes.length > 0) {
            const nodeId = params.nodes[0];
            if (isShift) {
              if (selectedNodes.has(nodeId)) selectedNodes.delete(nodeId);
              else selectedNodes.add(nodeId);
              updateSelectionUI();
              graphNetwork.unselectAll();
              return;
            }
            selectedNodes.clear();
            updateSelectionUI();
            showNodeDetail(nodeId);
          } else if (params.edges.length > 0) {
            const edgeId = params.edges[0];
            const e = graphEdgesDS.get(edgeId);
            if (e) showEdgeDetail(e.from, e.to);
          } else {
            if (!isShift) {
              selectedNodes.clear();
              updateSelectionUI();
              document.getElementById('inspectorDetail').style.display = 'none';
              document.getElementById('inspectorAnalysis').style.display = 'none';
              document.getElementById('inspectorEmpty').style.display = 'block';
            }
          }
        });

      } catch (e) {
        console.error('Graph render error:', e);
        container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-muted);font-size:14px;">Failed to load graph</div>';
      }
    }

    // ── Filter wiring ──
    let activeEntityFilters = new Map(); // type -> Set of entity IDs to show (empty = show all)
    let expandedFilterType = null;
    
    function populateEntityFilterPanel(type) {
      const panel = document.getElementById('entityFilterPanel');
      const list = document.getElementById('entityFilterList');
      const title = document.getElementById('entityFilterTitle');
      
      if (!graphRawData || !graphRawData.nodes) return;
      
      const typeColor = TYPE_COLORS[type] || '#64748b';
      title.textContent = `Filter ${type}s`;
      title.style.color = typeColor;
      
      // Get all entities of this type, sorted by weight
      const entities = graphRawData.nodes
        .filter(n => n.type === type)
        .sort((a, b) => (b.mentions || b.weight || 0) - (a.mentions || a.weight || 0));
      
      if (entities.length === 0) {
        list.innerHTML = '<div style="font-size:11px;color:var(--text-muted);padding:8px;">No entities of this type</div>';
        return;
      }
      
      const selectedIds = activeEntityFilters.get(type) || new Set();
      const showAll = selectedIds.size === 0;
      
      list.innerHTML = entities.map(e => {
        const isSelected = showAll || selectedIds.has(e.id);
        const weight = e.mentions || e.weight || 1;
        const importanceClass = weight >= 5 ? 'importance-high' : weight >= 2 ? 'importance-medium' : 'importance-low';
        return `
          <label class="entity-filter-item ${isSelected ? 'selected' : ''}" data-id="${e.id}">
            <input type="checkbox" ${isSelected ? 'checked' : ''} data-entity-id="${e.id}">
            <span class="entity-dot" style="background:${typeColor}"></span>
            <span class="${importanceClass}">${e.label}</span>
            <span class="entity-weight">${weight}x</span>
          </label>
        `;
      }).join('');
      
      // Wire up checkboxes
      list.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', () => {
          const entityId = cb.dataset.entityId;
          let typeSet = activeEntityFilters.get(type);
          
          if (cb.checked) {
            // If we were showing all, initialize with all IDs first
            if (!typeSet || typeSet.size === 0) {
              typeSet = new Set(entities.map(e => e.id));
              activeEntityFilters.set(type, typeSet);
            }
            typeSet.add(entityId);
          } else {
            if (!typeSet) {
              // First uncheck - create set with all EXCEPT this one
              typeSet = new Set(entities.filter(e => e.id !== entityId).map(e => e.id));
              activeEntityFilters.set(type, typeSet);
            } else {
              typeSet.delete(entityId);
            }
          }
          
          // Update visual
          cb.closest('.entity-filter-item').classList.toggle('selected', cb.checked);
          applyFilters();
        });
      });
    }
    
    // Select All / None buttons
    document.getElementById('entitySelectAll').addEventListener('click', () => {
      if (!expandedFilterType) return;
      activeEntityFilters.delete(expandedFilterType); // Empty = show all
      populateEntityFilterPanel(expandedFilterType);
      applyFilters();
    });
    
    document.getElementById('entitySelectNone').addEventListener('click', () => {
      if (!expandedFilterType) return;
      activeEntityFilters.set(expandedFilterType, new Set()); // Empty set = show none
      populateEntityFilterPanel(expandedFilterType);
      applyFilters();
    });
    
    document.querySelectorAll('.graph-chip-wrapper').forEach(wrapper => {
      const chip = wrapper.querySelector('.graph-chip');
      const type = chip.dataset.type;
      
      chip.addEventListener('click', (e) => {
        const panel = document.getElementById('entityFilterPanel');
        
        // If shift-click, toggle the entire type
        if (e.shiftKey) {
          chip.classList.toggle('active');
          if (activeTypeFilters.has(type)) activeTypeFilters.delete(type);
          else activeTypeFilters.add(type);
          applyFilters();
          return;
        }
        
        // Regular click - expand/collapse filter panel
        const wasExpanded = wrapper.classList.contains('expanded');
        
        // Collapse all
        document.querySelectorAll('.graph-chip-wrapper').forEach(w => w.classList.remove('expanded'));
        
        if (wasExpanded) {
          panel.classList.remove('visible');
          expandedFilterType = null;
        } else {
          wrapper.classList.add('expanded');
          panel.classList.add('visible');
          expandedFilterType = type;
          populateEntityFilterPanel(type);
        }
      });
    });

    document.querySelectorAll('.graph-time-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.graph-time-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeTimeFilter = parseInt(btn.dataset.mins) || 0;
        applyFilters();
      });
    });

    document.getElementById('graphSearch').addEventListener('input', (e) => {
      searchQuery = e.target.value.toLowerCase().trim();
      applyFilters();
    });

    document.getElementById('verifiedOnly').addEventListener('change', (e) => {
      verifiedOnly = e.target.checked;
      applyFilters();
    });

    document.getElementById('refreshGraphBtn').addEventListener('click', renderGraph);
    document.getElementById('analyzeGroupBtn').addEventListener('click', analyzeGroup);
    document.getElementById('clearSelectionBtn').addEventListener('click', () => {
      selectedNodes.clear();
      updateSelectionUI();
      if (graphNetwork) graphNetwork.unselectAll();
    });

    // Graph actions
    const graphActionStatus = document.getElementById('graphActionStatus');
    document.getElementById('exportGraphTextBtn').addEventListener('click', async () => {
      try {
        const data = await window.enk.getEntityGraph();
        const lines = [...(data.nodes || []).map(n => `${n.label} (${n.type})`), '', 'Connections:', ...(data.edges || []).map(e => `${e.sourceLabel || e.source} — ${e.targetLabel || e.target}`)];
        await navigator.clipboard.writeText(lines.join('\n'));
        const btn = document.getElementById('exportGraphTextBtn');
        const orig = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => { btn.textContent = orig; }, 1500);
      } catch (e) {
        graphActionStatus.textContent = 'Export failed: ' + (e?.message || 'Unknown');
      }
    });
    document.getElementById('pruneNoiseBtn').addEventListener('click', async () => {
      graphActionStatus.textContent = 'Pruning...';
      try {
        const result = await window.enk.pruneGraphNoise();
        graphActionStatus.textContent = result.nodesRemoved > 0 || result.edgesRemoved > 0
          ? `Pruned ${result.nodesRemoved} nodes, ${result.edgesRemoved} edges` : 'Noise already clean';
        renderGraph();
      } catch (e) {
        graphActionStatus.textContent = 'Prune failed: ' + (e?.message || 'Unknown');
      }
    });
    document.getElementById('resetGraphBtn').addEventListener('click', async () => {
      if (!confirm('Clear all entities and connections? This cannot be undone.')) return;
      try {
        await window.enk.resetGraph();
        graphActionStatus.textContent = 'Graph reset';
        renderGraph();
      } catch (e) {
        graphActionStatus.textContent = 'Reset failed: ' + (e?.message || 'Unknown');
      }
    });
  </script>
</body>
</html>
